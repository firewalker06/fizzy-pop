#!/usr/bin/env ruby

$stdout.sync = true

require_relative "../lib/fizzy_pop"

config = FizzyPop::Config.new(ARGV)

FizzyPop::Debug.verbose = config.verbose
FizzyPop::Debug.dry_run = config.dry_run

webhook_client = if config.webhook_url && config.webhook_token
  FizzyPop::WebhookClient.new(config.webhook_url, config.webhook_token)
end

agents = config.agents.map do |agent_config|
  FizzyPop::Agent.new(name: agent_config[:name], token: agent_config[:token], base_url: config.url, interval_agent_poll: config.interval_agent_poll)
end

agents.each(&:fetch_identity!)
active_agents = agents.select(&:active?)

if active_agents.empty?
  abort "No agents have valid accounts. Check your tokens."
end

# Collect all bot user IDs so agents can filter bot-to-bot notifications
bot_user_ids = active_agents.map(&:user_id).compact
puts "Bot user IDs for filtering: #{bot_user_ids.join(", ")}"

puts "Polling #{active_agents.length} agent(s) every #{config.interval_polling}s, webhook delivery every #{config.interval_webhook}s... (Ctrl+C to stop)"

Thread.abort_on_exception = true
queue = Queue.new

begin
  poll_thread = Thread.new do
    loop do
      active_agents.each { |agent| agent.poll_notifications(queue, bot_user_ids: bot_user_ids) }
      FizzyPop::Debug.reset_breadcrumbs
      sleep config.interval_polling
    end
  end

  webhook_thread = Thread.new do
    loop do
      item = queue.pop
      FizzyPop::Debug.breadcrumbs << "send_webhook:#{item[:agent_name]}"

      if webhook_client
        webhook_client.deliver(item[:agent_name], item[:message])
      elsif !FizzyPop::Debug.dry_run
        abort "Missing required --webhook-url and --webhook-token"
      end

      sleep config.interval_webhook
    end
  end

  poll_thread.join
  webhook_thread.join
rescue Interrupt, SignalException
  puts "\nBreadcrumbs: #{FizzyPop::Debug.breadcrumbs.join(" -> ")}"
  puts "\nShutting down..."
rescue StandardError => e
  puts "\nBreadcrumbs: #{FizzyPop::Debug.breadcrumbs.join(" -> ")}"
  puts "\nAn error occurred: #{e.message}"
end
